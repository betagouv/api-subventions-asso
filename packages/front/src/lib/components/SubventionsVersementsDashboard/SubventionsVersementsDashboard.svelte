<script>
    import Spinner from "../Spinner.svelte";
    import ProgressBar from "../ProgressBar.svelte";
    import DataNotFound from "../DataNotFound.svelte";
    import ErrorAlert from "../ErrorAlert.svelte";

    import SubventionsVersementsDashboardController from "./SubventionsVersementsDashboard.controller";
    import SubventionsVersementsStatistique from "./SubventionsVersementsStatistique/SubventionsVersementsStatistique.svelte";
    import SubventionTable from "./SubventionTable/SubventionTable.svelte";
    import VersementTable from "./VersementTable/VersementTable.svelte";
    import ProviderModal from "./Modals/ProviderModal/ProviderModal.svelte";
    import Alert from "$lib/dsfr/Alert.svelte";
    import Select from "$lib/dsfr/Select.svelte";
    import { modal } from "$lib/store/modal.store";
    import Button from "$lib/dsfr/Button.svelte";

    export let identifier;

    const controller = new SubventionsVersementsDashboardController(identifier);

    const promise = controller.load();

    const { loaderStateStore, elements, exercicesOptions, selectedExercice, selectedYear, sortDirection, sortColumn } =
        controller;

    const displayModal = () => {
        modal.update(() => ProviderModal);
    };
</script>

{#await promise}
    <Spinner description="Chargement des demandes de subventions en cours ..." />
{:then _null}
    <div class="fr-grid-row fr-mt-3w fr-py-2w flex space-between">
        <h2>Tableau de bord</h2>
        <div class="baseline">
            {#if $elements && $elements.length}
                <Button
                    on:click={() => controller.download()}
                    disabled={$loaderStateStore.status != "end"}
                    icon="download-line"
                    trackingDisable={true}
                    iconPosition="right">
                    Télécharger les données - (BÊTA)
                </Button>
            {/if}
        </div>
    </div>
    <div class="fr-grid-row fr-py-4w flex space-between">
        <div class="fr-col-3">
            {#if $exercicesOptions.length}
                <Select
                    on:change={event => controller.updateSelectedExercice(event.detail)}
                    selected={$selectedExercice}
                    options={$exercicesOptions} />
            {/if}
        </div>
        <Button
            type="tertiary"
            outline={false}
            ariaControls="fr-modal"
            on:click={displayModal}
            trakerName="association-etablissement.dashboard.display-provider-modal">
            Voir la liste des fournisseurs de données
        </Button>
    </div>
    <div class="fr-py-3w compact-columns">
        {#if $elements?.length}
            <SubventionsVersementsStatistique elements={$elements} year={$selectedYear} />
            {#if $loaderStateStore.status != "end"}
                <Alert type="info" title="Récupération en cours des subventions chez nos fournisseurs ...">
                    <ProgressBar percent={$loaderStateStore.percent} />
                </Alert>
            {/if}
            <div class="fr-grid-row fr-grid-row--gutters">
                <div class="fr-col-8">
                    <SubventionTable
                        elements={$elements}
                        sort={column => controller.sort(column)}
                        currentSort={$sortColumn}
                        sortDirection={$sortDirection} />
                </div>
                <div class="fr-col-4">
                    <VersementTable
                        elements={$elements}
                        sort={column => controller.sort(column)}
                        currentSort={$sortColumn}
                        sortDirection={$sortDirection} />
                </div>
            </div>
        {:else}
            <DataNotFound content={controller.notFoundMessage} />
        {/if}
    </div>
{:catch error}
    {#if error.request && error.request.status == 404}
        <DataNotFound />
    {:else}
        <ErrorAlert message={error.message} />
    {/if}
{/await}

<style>
    .baseline {
        align-self: baseline;
    }

    .compact-columns :global(.fr-grid-row--gutters) {
        margin: -0.5rem;
    }

    .compact-columns :global(.fr-grid-row--gutters > [class^="fr-col-"]) {
        padding: 0.5rem;
    }
</style>
