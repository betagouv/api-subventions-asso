<%- include('../header') -%>
<main role="main" id="contenu">
    <div class="fr-container fr-mb-8w">
        <%- include('../global_components/ariane', { items: [
            { label: 'Accueil', url: '/' },
            { label: 'Association', url: '/association/' + (helper.getValue(association.rna) || helper.getValue(association.siren) ) },
            { label: 'Établissement' },
            ],})
            -%>
            <div class="fr-grid-row fr-grid-row--center fr-grid-row--gutters">
                <div class="fr-col fr-col-xl-12">
                    <ul class="fr-accordions-group">
                        <li>
                            <section class="fr-accordion">
                                <h3 class="fr-accordion__title">
                                    <button class="fr-accordion__btn" aria-expanded="true" aria-controls="fr-accordion-0-body-0">Établissement</button>
                                </h3>
                                <div class="fr-collapse" id="fr-accordion-0-body-0">
                                    <% if (helper.hasValue(association.denomination)) { %>
                                        <h4><%- helper.getValue(association.denomination) -%> </h4>
                                    <% } %>
                                    <div class="fr-grid-row fr-grid-row--center fr-grid-row--gutters">
                                        <div class="fr-col fr-col-lg-6">
                                            <% if (helper.hasValue(association.rna)) { %>
                                                <p>RNA : <%- helper.getValue(association.rna) -%> </p>
                                            <% } %>
                                            <% if (helper.hasValue(etablissement.siret)) { %>
                                                <p>SIRET : <%- helper.getValue(etablissement.siret) -%> </p>
                                            <% } %>
                                            <% if (helper.hasValue(association.adresse_siege)) { %>
                                                <p>Adresse: <%- helper.adresse.toString(etablissement.adresse) -%> </p>
                                            <% } %>
                                        </div>
                                        <div class="fr-col fr-col-lg-6">
                                            <% if (helper.hasValue(etablissement.ouvert)) { %>
                                                <p>Etat administratif : <%- helper.getValue(etablissement.ouvert) ? "OUVERT" : "FERMER" -%></p>
                                            <% } %>
                                            <% if (helper.hasValue(etablissement.siege)) { %>
                                                <p>Siège : <%- helper.getValue(etablissement.siege) ? "OUI" : "NON" -%> </p>
                                            <% } %>
                                            <% if (helper.hasValue(etablissement.nic)) { %>
                                                <p>NIC : <%- helper.getValue(etablissement.nic) -%> </p>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="fr-grid-row fr-grid-row--center fr-grid-row--gutters">
                                        <% if ( etablissement.representants_legaux && etablissement.representants_legaux.length) { %>
                                            <div class="fr-col fr-col-lg-12">
                                                <div class="fr-table">
                                                    <table>
                                                        <caption>Représentants légaux</caption>
                                                        <thead>
                                                            <tr>
                                                                <th scope="col"> Nom </th>
                                                                <th scope="col"> Prenom </th>
                                                                <th scope="col"> Civilité </th>
                                                                <th scope="col"> Téléphone </th>
                                                                <th scope="col"> Email </th>
                                                                <th scope="col"> Role </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% for( let index = 0; index < etablissement.representants_legaux.length; index++ ) { %>
                                                                <% let representant = helper.getValue(etablissement.representants_legaux[index]) %>
                                                                <tr>
                                                                    <td><%- representant.nom %></td>
                                                                    <td><%- representant.prenom %></td>
                                                                    <td><%- representant.civilite %></td>
                                                                    <td><%- representant.telephone %></td>
                                                                    <td><%- representant.email %></td>
                                                                    <td><%- representant.role %></td>
                                                                </tr>
                                                            <% } %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div> 
                                        <% } %>
                                        <% if (etablissement.contacts && etablissement.contacts.length) { %>
                                            <div class="fr-col fr-col-lg-12">
                                                <div class="fr-table">
                                                    <table>
                                                        <caption>Contacts</caption>
                                                        <thead>
                                                            <tr>
                                                                <th scope="col"> Nom </th>
                                                                <th scope="col"> Prenom </th>
                                                                <th scope="col"> Civilité </th>
                                                                <th scope="col"> Téléphone </th>
                                                                <th scope="col"> Email </th>
                                                                <th scope="col"> Role </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% for( let index = 0; index < etablissement.contacts.length; index++ ) { %>
                                                                <% let contact = helper.getValue(etablissement.contacts[index])%>
                                                                <tr>
                                                                    <td><%- contact.nom %></td>
                                                                    <td><%- contact.prenom %></td>
                                                                    <td><%- contact.civilite %></td>
                                                                    <td><%- contact.telephone %></td>
                                                                    <td><%- contact.email %></td>
                                                                    <td><%- contact.role %></td>
                                                                </tr>
                                                            <% } %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div> 
                                        <% } %>
                                    </div>
                                    <% if (etablissement.information_banquaire && etablissement.information_banquaire.length) { %>
                                        <div class="fr-col fr-col-lg-12">
                                            <div class="fr-table">
                                                <table>
                                                    <caption>Informations banquaire</caption>
                                                    <thead>
                                                        <tr>
                                                            <th scope="col"> BIC </th>
                                                            <th scope="col"> IBAN </th>
                                                            <th scope="col"> Dernière modification</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% for( let index = 0; index < etablissement.information_banquaire.length; index++ ) { %>
                                                            <% let information_banquaire = helper.getValue(etablissement.information_banquaire[index])%>
                                                            <tr>
                                                                <td><%- information_banquaire.bic %></td>
                                                                <td><%- information_banquaire.iban %></td>
                                                                <td><%- helper.date.formatDate(helper.getDate(etablissement.information_banquaire[index])) %></td>
                                                            </tr>
                                                        <% } %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div> 
                                    <% } %>
                                    <div class="fr-grid-row fr-grid-row--left fr-grid-row--gutters">
                                        <div class="fr-col fr-col-lg-6">
                                            <% if (helper.hasValue(association.nic_siege) && helper.hasValue(association.siren)) { %>
                                                <%- include('../global_components/tile',
                                                {
                                                    title: 'Télécharger l\'avis de situation',
                                                    desc: "Télécharger l\'avis de situation de l'établissement",
                                                    url: 'https://api.avis-situation-sirene.insee.fr/identification/pdf/' + helper.getValue(etablissement.siret),
                                                    img: '/static/images/logo_insee.jpg',
                                                    target: "_blank"
                                                })
                                                -%>
                                            <% } %>
                                        </div>
                                        <div class="fr-col fr-col-lg-6">
                                            <%- include('../global_components/tile',
                                            {
                                                title: 'Télécharger les données brut',
                                                desc: "Télécharger les données disponible au format JSON",
                                                url: '/download/json/etablissement/' + helper.getValue(etablissement.siret),
                                                img: '/static/images/json.png',
                                                download: "etablissement-"+ helper.getValue(etablissement.siret) +".json"
                                            })
                                            -%>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </li>
                        <li>
                            <section class="fr-accordion">
                                <h3 class="fr-accordion__title">
                                    <button class="fr-accordion__btn" aria-expanded="false" aria-controls="fr-accordion-1-body-1">Informations administratives de l'Association</button>
                                </h3>
                                <div class="fr-collapse" id="fr-accordion-1-body-1">
                                    <div class="fr-grid-row fr-grid-row--center fr-grid-row--gutters">
                                        <div class="fr-col fr-col-lg-6">
                                            <% if (helper.hasValue(association.denomination)) { %>
                                                <p><%- helper.getValue(association.denomination) -%> </p>
                                            <% } %>
                                        </div>
                                        <div class="fr-col fr-col-lg-6">

                                            <a href="<%- '/association/' + (helper.getValue(association.rna) || helper.getValue(association.siren)) %>">
                                                <button class="fr-btn" title="Label bouton">
                                                    Voir la page de l'association
                                                </button>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="fr-grid-row fr-grid-row--center fr-grid-row--gutters">
                                        <div class="fr-col fr-col-lg-6">
                                            <% if (helper.hasValue(association.rna)) { %>
                                                <p>RNA : <%- helper.getValue(association.rna) -%> </p>
                                            <% } %>
                                            <% if (helper.hasValue(association.siren)) { %>
                                                <p>SIREN : <%- helper.getValue(association.siren) -%> </p>
                                            <% } %>
                                            <% if (helper.hasValue(association.nic_siege) && helper.hasValue(association.siren)) { %>
                                                <p>SIRET du siège : <%- helper.getValue(association.siren) -%><%- helper.getValue(association.nic_siege) -%></p>
                                            <% } %>
                                        </div>
                                        <div class="fr-col fr-col-lg-6">
                                            <% if (helper.hasValue(association.adresse_siege)) { %>
                                                <p>Adresse du siège : <%- helper.adresse.toString(association.adresse_siege) -%> </p>
                                            <% } %>
                                            <% if (helper.hasValue(association.date_creation)) { %>
                                                <p>Date d'immatriculation : <%- helper.date.toString(association.date_creation) -%> </p>
                                            <% } %>
                                            <% if (helper.hasValue(association.date_modification)) { %>
                                                <p>Dernière modification au greffe : <%- helper.date.toString(association.date_modification) -%> </p>
                                            <% } %>
                                        </div>
                                    </div>

                                    <% if (helper.hasValue(association.objet_social)) { %>
                                    <p>Objet social : </p>
                                    <div class="fr-grid-row fr-grid-row--left fr-grid-row--gutters">
                                        <div class="fr-col fr-col-lg-6">
                                            <p><%- helper.getValue(association.objet_social) -%></p>
                                        </div>
                                        <div class="fr-col fr-col-lg-6">
                                            <p>Code objet social: <%- helper.getValue(association.code_objet_social_1) -%></p>
                                        </div>
                                    </div>
                                    <% } %>
                                </div>
                            </section>
                        </li>

                        <li>
                            <section class="fr-accordion">
                                <h3 class="fr-accordion__title">
                                    <button class="fr-accordion__btn" aria-expanded="false" aria-controls="fr-accordion-2-body-2">Demandes de subventions</button>
                                </h3>
                                <div class="fr-collapse" id="fr-accordion-2-body-2">
                                    <div class="fr-grid-row fr-grid-row--left fr-grid-row--gutters">
                                        <div class="fr-col fr-col-lg-12">
                                            <ul class="fr-accordions-group">
                                                <%const years = [...subventions.years].sort().reverse();%>
                                                <% for( let index = 0; index < years.length; index++ ) { %>
                                                    <% const year = years[index]; const yearText = year === "0000" ? "Année non communiqué" : year%>
                                                    <li>
                                                        <section class="fr-accordion">
                                                            <h3 class="fr-accordion__title">
                                                                <button class="fr-accordion__btn" aria-expanded="<%- index === 0 ? "true": "false" %>" aria-controls="fr-accordion-1<%- index %>-body-1<%- index %>"><%-yearText%></button>
                                                            </h3>
                                                            <div class="fr-collapse" id="fr-accordion-1<%- index %>-body-1<%- index %>">
                                                                    <p>Montants des subventions attribuées (<%- yearText -%>) : <%- subventions.totalAccordeByYear[year] -%>€</p>
                                                                    <ul class="fr-accordions-group">
                                                                        <li>
                                                                            <section class="fr-accordion">
                                                                                <h3 class="fr-accordion__title">
                                                                                    <button class="fr-accordion__btn" aria-expanded="true" aria-controls="fr-accordion-1<%- index %>2-body-1<%- index %>2">Montants totals</button>
                                                                                </h3>
                                                                                <div class="fr-collapse" id="fr-accordion-1<%- index %>2-body-1<%- index %>2">
                                                                                    <div class="fr-grid-row fr-grid-row--left fr-grid-row--gutters">
                                                                                        <% const reqByStatus = Object.keys(subventions.byYear[year]);%> 
                                                                                        <% for( let index = 0; index < reqByStatus.length; index++ ) { %>
                                                                                            <div class="fr-col fr-col-lg-6"">
                                                                                                <div class="fr-table">
                                                                                                    <table>
                                                                                                        <caption><%- reqByStatus[index] %></caption>
                                                                                                        <thead>
                                                                                                            <tr>
                                                                                                                <th scope="col">Service Instructeur</th>
                                                                                                                <!-- <th scope="col">Total</th> -->
                                                                                                                <th scope="col">Demandé</th>
                                                                                                                <th scope="col">Proposé</th>
                                                                                                                <th scope="col">Accordé</th>
                                                                                                            </tr>
                                                                                                        </thead>
                                                                                                        <tbody>
                                                                                                            <% const services = subventions.byYear[year][reqByStatus[index]];%>
                                                                                                            <% for( let y = 0; y < Object.keys(services).length; y++ ) { %>
                                                                                                                <% const serviceName = Object.keys(services)[y]; const serivce = services[serviceName];  %>
                                                                                                                <% if (Object.keys(serivce).length != 0) { %>
                                                                                                                    <tr>
                                                                                                                        <td><%- serviceName %></td>
                                                                                                                        <% for( let z = 0; z < Object.keys(serivce).length; z++) { %>
                                                                                                                            <% if (Object.keys(serivce)[z] !=  "total") { %>

                                                                                                                                <td><%- Object.values(serivce)[z] %></td>
                                                                                                                            <% } %>
                                                                                                                        <% } %>
                                                                                                                    </tr>
                                                                                                                <% } %>
                                                                                                            <% } %>
                                                                                                        </tbody>
                                                                                                    </table>
                                                                                                </div>
                                                                                            </div>
                                                                                        <% } %>
                                                                                    </div>
                                                                                </div>
                                                                            </section>
                                                                        </li>
                                                                        <li>
                                                                            <section class="fr-accordion">
                                                                                <h3 class="fr-accordion__title">
                                                                                    <button class="fr-accordion__btn" aria-expanded="false" aria-controls="fr-accordion-1<%- index %>3-body-1<%- index %>3">Détails</button>
                                                                                </h3>
                                                                                <div class="fr-collapse" id="fr-accordion-1<%- index %>3-body-1<%- index %>3">
                                                                                    <div class="fr-table">
                                                                                        <table>
                                                                                            <caption>Demandes de subventions</caption>
                                                                                            <thead>
                                                                                                <tr>
                                                                                                    <th scope="col">Status</th>
                                                                                                    <th scope="col">Service instructeur</th>
                                                                                                    <th scope="col">Dispositif</th>
                                                                                                    <th scope="col">N°EJ</th>
                                                                                                    <th scope="col">Année de la demande</th>
                                                                                                    <th scope="col">Date de la commision</th>
                                                                                                    <th scope="col">Pluriannuel</th>
                                                                                                    <th scope="col">Montants Accordé</th>
                                                                                                    <th scope="col">Provider</th>
                                                                                                    <th scope="col">Plus d'information</th>
                                                                                                </tr>
                                                                                            </thead>
                                                                                            <tbody>
                                                                                                <% for(let i = 0; i < subventions.demandes[year].length; i++ ) { %>
                                                                                                    <% const demande = subventions.demandes[year][i];%> 
                                                                                                    <tr>
                                                                                                        <td><%-helper.getValue(demande.status) || "NC" %></td>
                                                                                                        <td><%-helper.getValue(demande.service_instructeur)%></td>
                                                                                                        <td><%-helper.getValue(demande.dispositif)%></td>
                                                                                                        <td><%-helper.getValue(demande.ej)%></td>
                                                                                                        <td><%-helper.getValue(demande.annee_demande)%></td>
                                                                                                        <td><%-helper.date.toProviderValueString(demande.date_commision)%></td>
                                                                                                        <td><%-helper.getValue(demande.pluriannualite)%></td>
                                                                                                        <td><%- demande.montants && demande.montants.accorde ? helper.getValue(demande.montants.accorde) : ""%></td>
                                                                                                        <td><%-helper.getProvider(demande.service_instructeur)%></td>
                                                                                                        <td>
                                                                                                            <a download="demande_subvention.json" href="data:application/json;base64,<%- helper.toJSONFile(demande) %>">
                                                                                                                <button class="fr-btn fr-fi-file-download-line" title="Télécharger les données sur la demande de subvention">
                                                                                                                    Télécharger les données sur la demande de subvention
                                                                                                                </button>
                                                                                                            </a>

                                                                                                        </td>
                                                                                                    </tr>
                                                                                                <% } %>
                                                                                            </tbody>
                                                                                        </table>
                                                                                    </div>
                                                                                </div>
                                                                            </section>
                                                                        </li>
                                                                    </ul>
                                                            </div>
                                                        </section>
                                                    </li>                                                   
                                                <% } %>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</main>
<%- include('../footer') -%>